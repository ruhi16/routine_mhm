<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head'); %>
  </head>
  
  <body class="container">

    <header>
      <%- include('../partials/header'); %>
    </header>
    <% selected_day = weekdays.filter( wkday =>{
      return wkday.status === 'active';
    }) %>
    <% var wkday = selected_day[0].day_id; %>
    <!-- <%= wkday %> -->
    <%  
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const d = new Date();
        let day = d.getDate();
        let month = months[d.getMonth()];
        let year = d.getFullYear();
        let today = days[d.getDay()];        
    %>

    <% var absentTeachers = []; %>
    <% provisionals[0].absentees.forEach(absentee=>{%>
      <% absentTeachers.push(absentee.teacher); %>
      <!-- <%= absentee.teacher.name %><br/> -->
    <% }); %>

    <!-- // ============================= // -->

    <% var provisionalAttendTeachers = []; %>
    <% var n = Number(weekday.periods) %> 
    <!-- <%= n %> -->
    <% for (var i =0; i < n;  i++ ) { %>
      <% var provisionalPeriodWiseAttendTeachers = []; %>

        <% provisionals[0].absentees.forEach(absentee=>{%>
          
          <!-- <%= absentee.teacher.name %>: -->

          <% if(absentee.periods ){ %>
            
              <% absentee.periods.map(period => { %>
                <!-- <%= period.period_no %>: -->
                <!-- <%= period.class.name %><%= period.section.name %> -->
                
                <% if(period.period_no == i+1){ %>
                    <% if(period.teacher ){ %>
                      <!-- <%= period.teacher.shortName %> -->
                      <% provisionalPeriodWiseAttendTeachers.push(period.teacher) %>
                    <% } %>
                <% } %>
              
              <% }); %>
          <% } %>
          <!-- <br/> -->
        <% }); %>

        <% provisionalAttendTeachers.push({
          period_no: (i+1),
          assigned_teachers: provisionalPeriodWiseAttendTeachers
        }); %>

    <% } %>

    <!-- <% provisionalAttendTeachers.forEach( period=>{ %>
      <% if(period.period_no === 2) {%>
        <%= JSON.stringify(period) %><br>
      <% } %>
    <% }) %> -->





    <h1>Provitional Routine, Today: <%= today %>, <%= day %> <%= month %>, <%= year %></h1></h1>
    <!-- Session: <%= session.name %>,
    Month: <%= month %>,
    Date: <%= d.getDate() %>,
    Day: <%= today %>, 
    <br> -->
    
    <% teachers.forEach( teacher => {%>
      <!-- <%= teacher.name %>, -->
    <% });%>
    <br>
    <% provisionals.forEach( provisional => { %>
      <!-- <%= provisional.absentees %> -->
      <% provisional.absentees.map( teacher =>{ %>
        <!-- <%= teacher %> -->
      <% }) %>
    <% }); %>

    <% var n = Number(weekday.periods) %>

    <!-- <% 
      var currentTime = new Date();
      var currentOffset = currentTime.getTimezoneOffset();      
      var ISTOffset = 330;   // IST offset UTC +5:30       
      var ISTTime = new Date(currentTime.getTime() + (ISTOffset + currentOffset)*60000);      
      var hoursIST = ISTTime.getHours();
      var minutesIST = ISTTime.getMinutes();
    %> -->

    <!-- <% date = ISTTime.getFullYear()+'-'+(ISTTime.getMonth()+1)+'-'+ISTTime.getDate() %>
    <%= date %>
    <% var dd = new Date(date) %> -->
    
    <!-- <%= ISTTime.getFullYear() %><br>
    <%= ISTTime.getMonth()+1 %><br>
    <%= ISTTime.getDate() %><br> -->
    <!-- <%= ISTTime.toISOString() %>
    <%= currentOffset %> -->




    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Name</th>          
                <!-- <%= n %> -->
            <% for (var i = 1; i <= n;  i++ ) { %>
              <th class="text-center"><%= i %></th>
            <% } %>

          <th scope="col" class="text-center">Actions
              <button type="button" id="btnAdd" class="btn btn-primary ml-5"  data-toggle="modal" data-target="#absTeacherAssignModal">Add</button>              
          </th>
        </tr>
      </thead>
      <tbody>

        <% provisionals.forEach( provisional => { %>
          <!-- <%= provisional.absentees %> -->
          <% var proTeacherSlNo = 1 %>
          <% provisional.absentees.map( absentee =>{ %>
            <tr>
              <td class="font-weight-bold"><%= proTeacherSlNo++ %></td>
              <th scope="col">                
                <%= absentee.teacher.name %><br>
                <p class="small">
                  <%= absentee.reason %> [<%= absentee.off_periods %>]
                </p>
              </th>

                <% var n = Number(weekday.periods) %>
                <!-- <%= n %> -->
                <% for (var i =1; i <= n;  i++ ) { %>
                  <td>
                    <!-- <%= absentee.teacher.name %> -->
                    <% absentee.periods.forEach( period => { %>
                      <% if( period.period_no === i){ %>
                        
                        <b><%= period.class.name %>-<%= period.section.name %></b><br/>
                        <small><%= period.subject.name %></small><br/>  
                        To: <b>
                          <!-- <%var str =  JSON.stringify(period.teacher) %>
                          gg<%= str %>gg -->
                          <% if(period.teacher){ %>
                            <%= period.teacher.name %>
                          <% } %>
                          
                        </b><br>

                        <!-- <button class="btn btn-primary btn-sm btnProvAssign" data-toggle="modal" data-target=".bd-example-modal-lg">Assign</button>                       -->
                        <button class="btn btn-primary btn-sm btnProvAssign" id="btnProvAssign" data-toggle="modal" data-target="#provClassAssignModal"
                          data-prd_no = <%= i %>
                          data-day_id = <%= provisional._id %>
                          data-abs_id = <%= absentee._id %>
                          data-prd_id = <%= period._id %>
                          >Assign</button>
                      <% } %>
                    <% }) %>
                  </td>
                <% } %>
              
              <td class="text-right">
                <button class="btn btn-warning">Arrived</button>
                
                <button class="btn btn-danger btnAbsDelete" id="btnAbsDelete"
                    data-prv_id = <%= provisionals[0]._id %>
                    data-abs_id = <%= absentee._id %>

                >Delete</button>
              </td>
            </tr>
            
            <% }) %>
          <% }); %>
            <tr>
              <th></th>
              <th scope="col">
                Sch Teacher
              </th>              
              <% var n = Number(weekday.periods) %>
              <% var periodWiseFreeTeachers = [] %>

              <% for (var i = 1; i <= n;  i++ ) { %>
                <td>
                  <% var scheduledTeachers = [] %>
                  <% schedules.forEach( schedule => { %>
                    <% if(schedule.period_no === i ){ %>
                      <% scheduledTeachers.push( schedule.teacher._id )  %>
                      <!-- <%= schedule.teacher.name %>, -->
                    <%}%>
                  <% }); %>
                  
                  <% var periodPrTeachers = teachers.filter( teacher => {%>
                    <% return ! JSON.stringify(scheduledTeachers).includes(teacher._id) %>
                  <% }); %>

                  <% periodPrTeachers.forEach(prPrTeacher => {%> 
                    <!-- <%= prPrTeacher.name %><br> -->
                  <% }) %>
                </td>

                <% periodWiseFreeTeachers.push(periodPrTeachers) %>
              <% } %>
              
              <td></td>
            </tr>
            <!-- <tr>
              <th></th>
              <th scope="col">
                Prov Teacher
              </th>              
              <% var n = Number(weekday.periods) %>   
              <% for (var i = 1; i <= n;  i++ ) { %>
                <td>
                  <% schedules.forEach( schedule => { %>
                    <% if(schedule.period_no === i ){ %>
                      <%= schedule.teacher.name %>,
                    <% } %>
                  <% }); %>
                </td>
              <% } %>
              
              <td></td>
            </tr> -->


      </tbody>
    </table>
    <!-- <%= (periodWiseFreeTeachers[0]) %> -->
<!-- <div class="row">
        <div class="col-md-12 text-right">
            <button type="button" class="btn btn-success">Cancel</button>
            <button type="button" class="btn btn-primary">Submit</button>            
        </div>
      </div> -->


      <% provisionals.forEach( provisional => { %>
        <%= provisional %>
      <% }); %>



      

      <!-- modal -->
      <div class="modal fade bd-example-modal-lg" id="provClassAssignModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">

            <form action="#" id="provClassAssignForm" name="provClassAssignForm" method="post">
              <div class="modal-header">Provisional Teacher Assignement</div>
              <div class="modal-body">

                <div class="form-group row">
                  <label for="provTeacher" class="col-sm-2 col-form-label">Teacher</label>
                  <div class="col-sm-10">
                    <select class="form-control" id="provTeacher" name="provTeacher">

                    </select>
                  </div>
                </div>                
                
            </div>
            <div class="modal-footer">        
              <button class="btn btn-info float-right mr-2" data-dismiss="modal">Cancel</button>
              <button type="submit" id="btnTeacherSubmit" form="provClassAssignForm" class="btn btn-warning float-right">Submit</button>

              <!-- <a class="btn btn-danger" data-dismiss="modal" value="Close" >Close</a> -->
            </div>
          </form>
          </div>
        </div>
      </div>



      <!-- modal -->
      <div class="modal fade bd-example-modal-lg" id="absTeacherAssignModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">

            <form method="post" id="provTeacherAssignForm">
              <div class="modal-header">Absentee Teachers</div>
              <div class="modal-body">
                
                <div class="form-group row">
                  <label for="teacher" class="col-sm-2 col-form-label">Teacher</label>
                  <div class="col-sm-10">
                    <select class="form-control" id="teacher" name="teacher">                     
      
                    </select>
                  </div>
                </div>
      
                <div class="form-group row">
                  <label for="reason" class="col-sm-2 col-form-label">Reason</label>
                  <div class="col-sm-10">
                    <select class="form-control" id="reason" name="reason">
                      <option name="" value="">Select</option>
                      <option name="reason[]" value="absent">Absent</option>
                      <option name="reason[]" value="onduty">Onduty</option>
                      <option name="reason[]" value="medical">Medical Leave</option>
                    </select>
                  </div>
                </div>

                <!-- <div class="form-group row">
                  <label for="reason" class="col-sm-2 col-form-label">Periods</label>
                  <div class="col-sm-10">

                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="1">1st
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="2">2nd
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="3">3rd
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="4">4th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="5">5th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="6">6th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="7">7th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="8">8th
                      </label>
                    </div>
                  </div>

                </div> -->
                
            </div>
            <div class="modal-footer">        
              <button class="btn btn-info float-right mr-2" data-dismiss="modal">Cancel</button>
              <button type="submit" id="btnSubmit" class="btn btn-warning float-right">Submit</button>
                
              
              <!-- <a class="btn btn-danger" data-dismiss="modal" value="Close" >Close</a> -->
            </div>
          </form>
          </div>
        </div>
      </div>

      <!-- <h1>Absent Teachers List:</h1>
      <% var absentTeachers = []; %>
      <% provisionals[0].absentees.forEach(absentee=>{%>
        <% absentTeachers.push(absentee.teacher); %>
        <%= absentee.teacher.name %><br/>
      <% }); %> -->


    <footer>
      <%- include('../partials/footer'); %>
    </footer>




  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript">

  </script>

  </body>
</html>


<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>

<script type="text/javascript" >
  $(document).ready(function(e){
    var teachers = '<%- JSON.stringify(teachers) %>';
    var teachersObj = JSON.parse(teachers);

    var absentTeachers = '<%- JSON.stringify(absentTeachers) %>';
    var absentTeachersObj = JSON.parse(absentTeachers);

    
    // var provisionalAttendTeachers = '<%- JSON.stringify(provisionalAttendTeachers) %>';
    // var provisionalAttendTeachersObj = JSON.parse(provisionalAttendTeachers);
    // console.log(provisionalAttendTeachersObj);


    $('.btnAbsDelete').click(function(){
        var provisionalId = $(this).data('prv_id');
        var absenteeId = $(this).data('abs_id');
        // alert(provisionalId+'/'+absenteeId);


        $.ajax({
          url: "/provisional/ajax/provisional-teacher-delete",
          method: "post",
          // dataType: "json",
          // async: false,
          contentType: "application/json",
          data: JSON.stringify({
              prov_day_id: provisionalId, absentee_id: absenteeId
          }),

          success: function(msg){
            console.log("success ajax:" + msg.response );
            console.log("success ajax:" + JSON.stringify(msg) );
          },
          error: function(err){
            console.log("error:"+err);
          }
        });



    });

    $('#btnAdd').click(function(){
      
        $('#teacher').empty();
        $('#teacher').append('<option name="" value="">Select</option>');
        for (const teacher of teachersObj) {     
          if(! absentTeachers.includes(teacher._id)){        
            $('#teacher').append('<option value = "'+ teacher._id +'">'+ teacher.name +'</option>');        
          }
      
        }

    });

    // $('#btnSubmit').click(function(e){

    // });

    // $("#provClassAssignForm").on("submit", function(event){
    //   alert('submitted')
    // });

    $("#provTeacherAssignForm").submit( function(event){
        event.preventDefault();
        
        var tech = $('#teacher').val();
        var resn = $('#reason').val();
        
        var array = [];
        $("input:checkbox[name=periods]:checked").each(function() {
            array.push($(this).val());
            alert($(this).val());
            // array.push();
        });
        // alert(tech+'='+resn+'='+array);

        $.ajax({
          url: "/provisional/ajax/teacher-submit",
          method: "post",
          // dataType: "json",
          // async: false,
          contentType: "application/json",
          data: JSON.stringify({
              teacher: tech, reason: resn
          }),

          success: function(msg){
            console.log("success ajax:" + msg.response );
            // console.log("success ajax:" + JSON.stringify(msg) );
          },
          error: function(err){
            console.log("error:"+err);
          }
        });

    });

    // =================================================================================

    var schedules = '<%- JSON.stringify(schedules) %>';
    var schedulesObj = JSON.parse(schedules);

    var prd_no = '';
    var day_id = '';
    var abs_id = '';
    var prd_id = '';

    $('.btnProvAssign').click(function(){
        var prWiseFreeTeachers = '<%- JSON.stringify(periodWiseFreeTeachers) %>';
        var prWiseFreeTeachersObj = JSON.parse(prWiseFreeTeachers);

        var provisionalAttendTeachers = '<%- JSON.stringify(provisionalAttendTeachers) %>';
        var provisionalAttendTeachersObj = JSON.parse(provisionalAttendTeachers);
        
        prd_no = $(this).data('prd_no');        
        day_id = $(this).data('day_id');
        abs_id = $(this).data('abs_id');
        prd_id = $(this).data('prd_id');

        console.log(prd_no)
        console.log(provisionalAttendTeachersObj[prd_no-1].assigned_teachers);
        var provAssignedTeachers = [];
        if(provisionalAttendTeachersObj[prd_no-1].assigned_teachers){
          provisionalAttendTeachersObj[prd_no-1].assigned_teachers.forEach(teacher => {
            provAssignedTeachers.push(teacher._id);
            console.log(teacher._id);
          })
        }

        $('#provTeacher').empty();
        $('#provTeacher').append('<option name="" value="">Select</option>'); 
        for (const teacher of prWiseFreeTeachersObj[prd_no-1]) {
          

          if(! absentTeachers.includes(teacher._id)){
            
            if(! provAssignedTeachers.includes(teacher._id)){

                // console.log(teacher.name);
                var schTeacher = schedulesObj.filter( schedule => {
                  return schedule.teacher._id === teacher._id ;              
                });
                var class_details = 'Total: '+String(schTeacher.length) + ' => ';
                // console.log(schTeacher);
                // console.log(schTeacher.length);
                schTeacher.map( sch => {
                  class_details = class_details + sch.period_no +':' +sch.class.name + sch.section.name +' - ' 
                });
                // console.log(teacher._id + '-' + teacher.name);
                $('#provTeacher').append('<option value = "'+ teacher._id +'">'+ teacher.name +' [' + class_details +']</option>');
            }

          }

        }

    });

    $('#provClassAssignForm').submit(function(event){
      event.preventDefault();
      // alert('teacher submitted');
        console.log('prov day:' + day_id);
        console.log('prov day > absentee:' + abs_id);
        console.log('prov day > absentee > off_period:' + prd_id);
        console.log('prov day > absentee > off_period No:' + prd_no);
        
        var provAssignTeacher_id = $('#provTeacher').val();
        console.log('prov Teacher: '+provAssignTeacher_id);



      $.ajax({
          url: "/provisional/ajax/provisional-teacher-submit",
          method: "post",
          // dataType: "json",
          // async: false,
          contentType: "application/json",
          data: JSON.stringify({
              provisional_day_id: day_id, 
              absentee_id: abs_id, 
              period_id: prd_id, 
              provisional_teacher_id: provAssignTeacher_id,
              period_no: prd_no
              
          }),

          success: function(msg){
            console.log("success ajax:" + msg.response );
            // console.log("success ajax:" + JSON.stringify(msg) );
          },
          error: function(err){
            console.log("error:"+err);
          }
        });




    });
    









  });
</script>
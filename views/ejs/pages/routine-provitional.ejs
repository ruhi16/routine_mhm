<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head'); %>
  </head>
  
  <body class="container">

    <header>
      <%- include('../partials/header'); %>
    </header>
    <% selected_day = weekdays.filter( wkday =>{
      return wkday.status === 'active';
    }) %>
    <% var wkday = selected_day[0].day_id; %>
    <%= wkday %>


    
    <%  const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const d = new Date();
        let month = months[d.getMonth()];
        let today = days[d.getDay()];        
    %>

    <h1>Provitional Routine</h1>
    Session: <%= session.name %>
    Date: <%= (new Date()).toLocaleDateString('en-US') %>
    Month: <%= month %>
    Day: <%= today %>
    <br>

    <% teachers.forEach( teacher => {%>
      <!-- <%= teacher.name %>, -->
    <% });%>
    <br>
    <% provisionals.forEach( provisional => { %>
      <!-- <%= provisional.absentees %> -->
      <% provisional.absentees.map( teacher =>{ %>
        <!-- <%= teacher %> -->
      <% }) %>
    <% }); %>

    <% var n = Number(weekday.periods) %>




    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Name</th>          
                <!-- <%= n %> -->
            <% for (var i = 1; i <= n;  i++ ) { %>
              <th class="text-center"><%= i %></th>
            <% } %>

          <th scope="col" class="text-center">Actions
              <button type="button" id="btnAdd" class="btn btn-primary ml-5"  data-toggle="modal" data-target="#absTeacherAssignModal">Add</button>              
          </th>
        </tr>
      </thead>
      <tbody>

        <% provisionals.forEach( provisional => { %>
          <!-- <%= provisional.absentees %> -->
          <% provisional.absentees.map( absentee =>{ %>
            <tr>
              <td></td>
              <th scope="col">                
                <%= absentee.teacher.name %><br>
                <p class="small">
                  <%= absentee.reason %> [<%= absentee.off_periods %>]
                </p>
              </th>

                <% var n = Number(weekday.periods) %>
                <!-- <%= n %> -->
                <% for (var i =1; i <= n;  i++ ) { %>
                  <td>
                    <!-- <%= absentee.teacher.name %> -->
                    <% absentee.periods.forEach( period => { %>
                      <% if( period.period_no === i){ %>
                        <b><%= period.class.name %>-<%= period.section.name %></b><br/>
                        <small><%= period.subject.name %></small><br/>  
                        To: <b><%= %></b><br>
                        <!-- <button class="btn btn-primary btn-sm btnProvAssign" data-toggle="modal" data-target=".bd-example-modal-lg">Assign</button>                       -->
                        <button class="btn btn-primary btn-sm" id="btnProvAssign" data-toggle="modal" data-target="#provClassAssignModal">Assign</button>
                      <% } %>
                    <% }) %>
                  </td>
                <% } %>
              
              <td>
                <button class="btn btn-warning">Present</button>
              </td>
            </tr>
            
            <% }) %>
          <% }); %>
            <tr>
              <th></th>
              <th scope="col">
                Sch Teacher
              </th>              
              <% var n = Number(weekday.periods) %>
              <% var periodWiseFreeTeachers = [] %>

              <% for (var i = 1; i <= n;  i++ ) { %>
                <td>
                  <% var scheduledTeachers = [] %>
                  <% schedules.forEach( schedule => { %>
                    <% if(schedule.period_no === i ){ %>
                      <% scheduledTeachers.push( schedule.teacher._id )  %>
                      <!-- <%= schedule.teacher.name %>, -->
                    <%}%>
                  <% }); %>
                  
                  <% var periodPrTeachers = teachers.filter( teacher => {%>
                    <% return ! JSON.stringify(scheduledTeachers).includes(teacher._id) %>
                  <% }); %>

                  <% periodPrTeachers.forEach(prPrTeacher => {%> 
                    <!-- <%= prPrTeacher.name %><br> -->
                  <% }) %>
                </td>
                <% periodWiseFreeTeachers.push(periodPrTeachers) %>
              <% } %>
              
              <td></td>
            </tr>
            <!-- <tr>
              <th></th>
              <th scope="col">
                Prov Teacher
              </th>              
              <% var n = Number(weekday.periods) %>   
              <% for (var i = 1; i <= n;  i++ ) { %>
                <td>
                  <% schedules.forEach( schedule => { %>
                    <% if(schedule.period_no === i ){ %>
                      <%= schedule.teacher.name %>,
                    <% } %>
                  <% }); %>
                </td>
              <% } %>
              
              <td></td>
            </tr> -->


      </tbody>
    </table>
    <!-- <%= (periodWiseFreeTeachers[0]) %> -->

      <div class="row">
        <div class="col-md-12 text-right">
            <button type="button" class="btn btn-success">Cancel</button>
            <button type="button" class="btn btn-primary">Submit</button>            
        </div>
      </div>

      <!-- <h1>All Teachers List:</h1>
      <% teachers.forEach(teacher =>{%>
        <%= teacher.name %>,
      <% }); %>

      <h1>Absent Teachers List:</h1>
      <% var absentTeachers = []; %>
      <% provisionals[0].absentees.forEach(absentee=>{%>
        <% absentTeachers.push(absentee.teacher); %>
        <%= absentee.teacher.name %><br/>
      <% }); %>

      <% absentTeachers.forEach( absentTeacher => { %>
        <%= absentTeacher %>
      <% }); %>

      <h1>Present Teachers List:</h1>
      <% var presentTeachers = []; %>
      <% teachers.forEach(teacher =>{%>
        <% absentTeachers.filter( abt => { %>
          <% if(! abt._id.equals(teacher._id) ){ %>
            <% presentTeachers.push(teacher) %>
          <% } %>

          <% return abt._id.equals(teacher._id) %>
        <% }); %>
        
      <% }); %>

      <% presentTeachers.forEach( presentTeacher => { %>
        <%= presentTeacher.name %>,
      <% }); %>
      <br/>
      
      
      <% var n = Number(weekday.periods) %>                
      <% for (var i =0; i < n;  i++ ) { %>
          i:<%= i+1%>
          <% schedules.forEach( schedule => { %>
            <% if(schedule.period_no === (i+1) ){ %>
              
              <%= schedule.teacher.name %>,
            <%}%>
          <% }); %>
          <br/>
      <% } %> -->
    


      <!-- <h1>Scheduled Teachers List:</h1>
      <% schedules.forEach(schedule=>{%>
        <%= schedule.teacher.name %><br/>
      <% }); %> -->

      <!-- modal -->
      <div class="modal fade bd-example-modal-lg" id="provClassAssignModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">

            <!-- <form action="#" method="post"> -->
              <div class="modal-header">Provisional Teacher Assignement</div>
              <div class="modal-body">
                
                <div class="form-group row">
                  <label for="provTeacher" class="col-sm-2 col-form-label">Teacher</label>
                  <div class="col-sm-10">
                    <select class="form-control" id="provTeacher" name="provTeacher">                     
      
                    </select>
                  </div>
                </div>                
                
            </div>
            <div class="modal-footer">        
              <button class="btn btn-info float-right mr-2" data-dismiss="modal">Cancel</button>
              <button type="submit" id="btnTeacherSubmit" class="btn btn-warning float-right">Submit</button>

              <!-- <a class="btn btn-danger" data-dismiss="modal" value="Close" >Close</a> -->
            </div>
          <!-- </form> -->
          </div>
        </div>
      </div>



      <!-- modal -->
      <div class="modal fade bd-example-modal-lg" id="absTeacherAssignModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">

            <form action="#" method="post">
              <div class="modal-header">Title</div>
              <div class="modal-body">
                
                <div class="form-group row">
                  <label for="teacher" class="col-sm-2 col-form-label">Teacher</label>
                  <div class="col-sm-10">
                    <select class="form-control" id="teacher" name="teacher">                     
      
                    </select>
                  </div>
                </div>
      
                <div class="form-group row">
                  <label for="reason" class="col-sm-2 col-form-label">Reason</label>
                  <div class="col-sm-10">
                    <select class="form-control" id="reason" name="reason">
                      <option name="" value="">Select</option>
                      <option name="reason[]" value="absent">Absent</option>
                      <option name="reason[]" value="onduty">Onduty</option>
                      <option name="reason[]" value="medical">Medical Leave</option>
                    </select>
                  </div>
                </div>

                <div class="form-group row">
                  <label for="reason" class="col-sm-2 col-form-label">Periods</label>
                  <!-- <div class="col-sm-10"> -->

                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="1">1st
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="2">2nd
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="3">3rd
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="4">4th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="5">5th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="6">6th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="7">7th
                      </label>
                    </div>
                    <div class="col-sm-1 form-check-inline">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="periods[]" value="8">8th
                      </label>
                    </div>
                  <!-- </div> -->

                </div>
                
            </div>
            <div class="modal-footer">        
              <button class="btn btn-info float-right mr-2" data-dismiss="modal">Cancel</button>
              <button type="submit" id="btnSubmit" class="btn btn-warning float-right">Submit</button>
                
              
              <!-- <a class="btn btn-danger" data-dismiss="modal" value="Close" >Close</a> -->
            </div>
          </form>
          </div>
        </div>
      </div>

    <footer>
      <%- include('../partials/footer'); %>
    </footer>


  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript">

  </script>

  </body>
</html>


<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>

<script type="text/javascript" >
  $(document).ready(function(e){
    var teachers = '<%- JSON.stringify(teachers) %>';
    var teachersObj = JSON.parse(teachers);

    $('#btnProvAssign').click(function(){
      
        $('#provTeacher').empty();
        $('#provTeacher').append('<option name="" value="">Select</option>');
        for (const teacher of teachersObj) {
          $('#provTeacher').append(
            '<option value = "'+ teacher._id +'">'+ teacher.name +'</option>'
          );
        }
    });



    $('#btnAdd').click(function(){            

        $('#teacher').empty();
        $('#teacher').append('<option name="" value="">Select</option>');
        for (const teacher of teachersObj) {     
          // if(!allotedTeachersArr.includes(teacher._id)){        
            $('#teacher').append('<option value = "'+ teacher._id +'">'+ teacher.name +'</option>');        
          // }
      
        }

    });

    $('#btnSubmit').click(function(e){

    });

    $("form").on("submit", function(event){
        event.preventDefault();
        
        var tech = $('#teacher').val();
        var resn = $('#reason').val();
        
        var array = [];
        $("input:checkbox[name=periods]:checked").each(function() {
            array.push($(this).val());
            alert($(this).val());
            // array.push();
        });
        // alert(tech+'='+resn+'='+array);

        $.ajax({
          url: "/provisional/ajax/teacher-submit",
          method: "post",
          // dataType: "json",
          // async: false,
          contentType: "application/json",
          data: JSON.stringify({
              teacher: tech, reason: resn
          }),

          success: function(msg){
            console.log("success ajax:" + msg.response );
            // console.log("success ajax:" + JSON.stringify(msg) );
          },
          error: function(err){
            console.log("error:"+err);
          }
        });

    });

  });
</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head'); %>
</head>
<body class="container">

<header>
  <%- include('../partials/header'); %>
</header>


<% var wkday = 1; %>

<ul class="nav nav-tabs" id="myTab" role="tablist">
  <% weekdays.forEach( weekday => { %>

    <li class="nav-item" role="presentation">
      <a class="nav-link <%= weekday.day_id === wkday ? 'active' : '' %>" " 
          id="<%= weekday.name %>-tab" data-toggle="tab" href="#<%= weekday.name %>" role="tab" aria-controls="home" aria-selected="false"><%= weekday.name %></a>
    </li>

  <% }); %>
</ul>

<div class="tab-content" id="myTabContent">

  <% weekdays.forEach( weekday => { %>
    <div class="tab-pane fade <%= weekday.day_id === wkday ? 'show active' : '' %>" 
            id="<%= weekday.name %>" role="tabpanel" aria-labelledby="<%= weekday.name %>-tab">
      <%= weekday.name %>
      <!-- <%= new Date().getDay();%> -->

        

        <div class = "row">
          <div class = "col-sm-10">
            <table class="table table-bordered">    
              <% cls_sections.forEach( (cls_section) =>{%>
                <tr>
                  <td>
                    <%= cls_section.classId.name %>-<%= cls_section.sectionId.name %><BR>Room:
                  </td>   

                  <% for(var i=0; i< weekday.periods; i++){ %>
                    <td>
                      <% data = schedules.filter(function(schedule){ 
                        return  schedule.weekday._id.equals(weekday._id ) && 
                                schedule.section._id.equals(cls_section.sectionId._id ) && 
                                schedule.class._id.equals(cls_section.classId._id )  &&
                                schedule.period_no == (i+1) ;
                      }) %>

                      
                      <% data.map(function(d){%>
                        <%  id = d._id %>
                        <%= d.subject.name %><br>                    
                        <%= d.teacher.name %><br>
                      <%}) %>

                     
                      <button class="btn btn-primary btnSave" data-toggle="modal" data-target=".bd-example-modal-lg"
                          data-id  ="<%= (typeof data == 'object' && data.length > 0)? id : '' %>"
                          data-wkid="<%= weekday._id %>"
                          data-clid="<%= cls_section.classId._id %>"
                          data-scid="<%= cls_section.sectionId._id %>"
                          data-prid="<%= i+1 %>">Assign</button>
                    </td>
                  <% } %>             



                </tr>
              <%}); %>          
            </table>
          </div>  

          <div class="col-sm-2">
            <table class="table table-bordered">
              <% Teachers.forEach( teacher => { %>                
                <tr>
                  <th scope="row" class="text-center btn-warning"><%= teacher.shortName %></th>                   
                  <td class="text-center small">
                
                    <% data = schedules.filter(function(schedule){ 
                      return  schedule.weekday._id.equals(weekday._id ) &&
                              schedule.teacher._id.equals(teacher._id);
                     }) %>
                    
                     Total: <%= data.length %>:<br>
                    
                    <% data.map(function(d){%>
                      <%= d.period_no %>(
                        <%= d.class.name %><%= d.section.name %>-
                      <!-- <%= d.subject.name %> -->
                      ),
                      <br>
                      <!-- <%= d.period_no %><br> -->
                    <%}) %>
    
    
                  </td> 
                </tr>              
              <% }); %>
          </table>
          </div>
        </div>

      <BR><BR>
    </div>  
  <% }); %>
  
</div>



<% Subjects.forEach((subject)=>{ %>
    <%= subject.name %>,
<% }); %>

<br><br>
<% Teachers.forEach((teacher)=>{ %>
  <%= teacher.name %>,
<% }); %>

<br><br>
<% cls_subjects.forEach((cls_subs)=>{ %>
  <%= cls_subs.class.name %>:
  <% cls_subs.subjects.forEach((subj)=>{ %>
    <%= subj.name %>,
  <% }); %>
<br>
<% }); %>


<!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bd-example-modal-lg">Large modal</button> -->

<!-- <%= JSON.stringify(schedules) %> -->
<% schedules.map(function(elem){ %>
  <%if( elem._id.equals('6223b45d6e090dc37bf4b613') ){ %> 
    <%= elem %><BR><BR>
  <% } %>
<% }); -%>
<br>

<% data = schedules.filter(function(elem){
  return elem._id.equals('6223b45d6e090dc37bf4b613')
})%>

<%= JSON.stringify(data) %>



// modal
<div class="modal fade bd-example-modal-lg" id="subjtechmodal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="/user" method="post">
        <div class="modal-header">Title</div>
        <div class="modal-body">

        

          <div class="form-group row">
            <label for="subject" class="col-sm-2 col-form-label">Subject</label>
            <div class="col-sm-10">
              <select class="form-control" id="subject" name="subject">
                <!-- <option name="" value="">Select</option> -->               
              </select>
            </div>
          </div>

          
          <div class="form-group row">
            <label for="teacher" class="col-sm-2 col-form-label">Teacher</label>
            <div class="col-sm-10">
              <select class="form-control" id="teacher" name="teacher">
                <option name="" value="">Select</option>
              </select>
            </div>
          </div>          
          
      </div>
      <div class="modal-footer">        
        <button class="btn btn-info float-right mr-2" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-warning float-right">Submit</button>
          
        
        <!-- <a class="btn btn-danger" data-dismiss="modal" value="Close" >Close</a> -->
      </div>
    </form>
    </div>
  </div>
</div>

<footer>
  <%- include('../partials/footer'); %>
</footer>

<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>

<script type="text/javascript" >
  $(document).ready(function(e){
    var id = null;
    var wk_id = ''; 
    var cl_id = '';
    var sc_id = '';
    var pr_id = '';

    $('.btnSave').click(function(){
      var subjects = '<%- JSON.stringify(Subjects) %>';
      var teachers = '<%- JSON.stringify(Teachers) %>';      
      var cls_subjs = '<%- JSON.stringify(cls_subjects) %>';
      var schedules = '<%- JSON.stringify(schedules) %>';


      id    = $(this).data('id')  ;
      wk_id = $(this).data('wkid');
      cl_id = $(this).data('clid');
      sc_id = $(this).data('scid');
      pr_id = $(this).data('prid');


      // var cls_subjObj = JSON.parse(cls_subjects);
      var subjectsObj = JSON.parse(subjects);
      var teachersObj = JSON.parse(teachers);
      
      var cls_subjsObj = JSON.parse(cls_subjs);
      var schedulesObj = JSON.parse(schedules);

      

//==================================================================
      allotedSubjects = schedulesObj.filter( schedule => {
        return schedule.weekday._id === wk_id && 
          schedule.class._id === cl_id &&
          schedule.section._id === sc_id
      });

      allotedSubjectsArr = [];
      // console.log(allotedSubjects);
      allotedSubjects.forEach(allotedSubject => {
        // allotedSubjectsArr.push({"_id": allotedSubject.subject._id, "name": allotedSubject.subject.name});
        allotedSubjectsArr.push(allotedSubject.subject._id);
        
      });
      // console.log(allotedSubjectsArr);

      // find the selected subject
      $('#subject').empty();      
      const selectedClass = cls_subjsObj.find( (cls_subj) => {
        return cls_subj.class._id === cl_id;
      });

      $('#subject').append('<option name="" value="">Select</option>');
      selectedClass.subjects.map(subject => {
     
        if(!allotedSubjectsArr.includes(subject._id)){        
          $('#subject').append('<option value = "'+ subject._id +'">'+ subject.name +'</option>');
        }
      });
//==================================================================

    allotedTeachers = schedulesObj.filter( schedule => {
      return schedule.weekday._id === wk_id && schedule.period_no === pr_id
        
    });
    // console.log(allotedTeachers);
    
    allotedTeachersArr = [];
    allotedTeachers.forEach(allotedTeacher => {
      allotedTeachersArr.push(allotedTeacher.teacher._id);
    });

    $('#teacher').empty();
    $('#teacher').append('<option name="" value="">Select</option>');

    for (const teacher of teachersObj) {
      // console.log(teacher.name);
      if(!allotedTeachersArr.includes(teacher._id)){        
        $('#teacher').append('<option value = "'+ teacher._id +'">'+ teacher.name +'</option>');        
      }
      // $('#teacher').append('<option value = "'+ teacher._id +'">'+ teacher.name +'</option>');
    }

    // alert("+"+data.length+"+");
    // alert("Button Clicked!!! wk:" + wk_id + "-cl:"+ cl_id + "-sc:"+ sc_id + "-pr:"+ pr_id );
    
    // get subjects for class selected
    // load modal's .... select-option(s) from here dynamically
     
    });




    $("form").on("submit", function(event){
      event.preventDefault();

      console.log(wk_id+"--"+cl_id+"--"+sc_id+"--"+pr_id);

      var subj = $('#subject').val();
      var tech = $('#teacher').val();
      console.log(subj+tech);
      // alert(subj+tech);

      $.ajax({
        url: "/ajax",
        method: "post",
        // dataType: "json",
        // async: false,
        contentType: "application/json",
        data: JSON.stringify({
            id: id,
            wkday_id: wk_id, 
            class_id: cl_id, 
            section_id: sc_id,
            period_id: pr_id,
            subject_id: subj, 
            teacher_id: tech
        }),

        success: function(msg){
          console.log("success ajax:" + msg.response );
          console.log("success ajax:" + JSON.stringify(msg) );
        },
        error: function(err){
          console.log("error:"+err);
        }
      });
      
      
      
            
    });
  });
</script>

</body>
</html>